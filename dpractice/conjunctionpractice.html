<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conjunction Practice</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/7.1.0/docx.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .worksheet-container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .grade-box {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            border: 2px solid white;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            min-width: 120px;
        }

        .grade-box h3 {
            font-size: 1rem;
            margin-bottom: 5px;
        }

        .grade-score {
            font-size: 2rem;
            font-weight: bold;
        }

        .content {
            padding: 30px;
        }

        .student-info {
            background: #f8f9ff;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
            border-left: 5px solid #4facfe;
        }

        .student-info h2 {
            color: #4facfe;
            margin-bottom: 20px;
            font-size: 1.4rem;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .info-field {
            display: flex;
            flex-direction: column;
        }

        .info-field label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #555;
        }

        .info-field input {
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .info-field input:focus {
            outline: none;
            border-color: #4facfe;
        }

        .info-field input:disabled {
            background: #f5f5f5;
            color: #666;
        }

        .save-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: background 0.3s;
        }

        .save-btn:hover:not(:disabled) {
            background: #218838;
        }

        .save-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .place-image {
            width: 100%;
            height: 300px;
            object-fit: cover;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        .section {
            margin-bottom: 35px;
            background: #f8f9ff;
            border-radius: 10px;
            padding: 25px;
            border-left: 5px solid #4facfe;
        }

        .section h3 {
            color: #4facfe;
            font-size: 1.4rem;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
        }

        .instruction {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-style: italic;
            color: #1565c0;
        }

        .question {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            border: 2px solid #e9ecef;
            transition: border-color 0.3s;
        }

        .question:hover {
            border-color: #4facfe;
        }

        .question-text {
            font-weight: 600;
            margin-bottom: 15px;
            font-size: 1.1rem;
            color: #333;
        }

        .fill-blank {
            display: inline-block;
            min-width: 120px;
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            margin: 0 5px;
            font-size: 1rem;
            text-align: center;
        }

        .fill-blank:focus {
            outline: none;
            border-color: #4facfe;
            background: #f0f8ff;
        }

        .fill-blank.correct {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }

        .fill-blank.incorrect {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }

        .matching-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 20px;
        }

        .matching-column {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #e9ecef;
        }

        .matching-column h4 {
            color: #4facfe;
            margin-bottom: 15px;
            text-align: center;
        }

        .matching-item {
            padding: 12px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .matching-item:hover {
            background: #e9ecef;
        }

        .matching-item.selected {
            background: #cce5ff;
            border-color: #4facfe;
        }

        .matching-item.correct {
            background: #d4edda;
            border-color: #28a745;
        }

        .matching-item.incorrect {
            background: #f8d7da;
            border-color: #dc3545;
        }

        .sentence-area {
            width: 100%;
            min-height: 100px;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            resize: vertical;
        }

        .sentence-area:focus {
            outline: none;
            border-color: #4facfe;
            background: #f0f8ff;
        }

        .sentence-area.checked {
            background: #f8f9fa;
        }

        .word-bank {
            background: #fff3cd;
            border: 2px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .word-bank h4 {
            color: #856404;
            margin-bottom: 10px;
        }

        .word-bank-items {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .word-bank-item {
            background: #fff;
            padding: 8px 12px;
            border: 2px solid #ffeaa7;
            border-radius: 5px;
            font-weight: 600;
            color: #856404;
        }

        .check-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            margin: 30px auto;
            display: block;
            transition: transform 0.3s;
        }

        .check-btn:hover:not(:disabled) {
            transform: translateY(-2px);
        }

        .check-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .footer {
            background: #f8f9fa;
            padding: 25px;
            border-top: 1px solid #e9ecef;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
        }

        .footer-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            transition: background 0.3s;
            min-width: 120px;
        }

        .footer-btn:hover {
            background: #5a6268;
        }

        .footer-btn.print { background: #17a2b8; }
        .footer-btn.copy { background: #28a745; }
        .footer-btn.pdf { background: #dc3545; }
        .footer-btn.docx { background: #007bff; }
        .footer-btn.screenshot { background: #6f42c1; }

        .footer-btn.print:hover { background: #138496; }
        .footer-btn.copy:hover { background: #218838; }
        .footer-btn.pdf:hover { background: #c82333; }
        .footer-btn.docx:hover { background: #0056b3; }
        .footer-btn.screenshot:hover { background: #5a2d91; }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .header {
                padding: 20px;
            }

            .header h1 {
                font-size: 1.8rem;
            }

            .grade-box {
                position: static;
                margin-top: 20px;
                margin-left: auto;
                margin-right: auto;
            }

            .content {
                padding: 20px;
            }

            .info-grid {
                grid-template-columns: 1fr;
            }

            .place-image {
                height: 200px;
            }

            .matching-container {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .footer {
                padding: 20px;
            }

            .footer-btn {
                flex: 1;
                min-width: auto;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.5rem;
            }

            .question-text {
                font-size: 1rem;
            }

            .fill-blank {
                min-width: 100px;
                margin: 5px 2px;
            }
        }
    </style>
</head>
<body>
    <div class="worksheet-container" id="worksheet">
        <div class="header">
            <h1>Conjunction Practice</h1>
            <div class="grade-box">
                <h3>Grade</h3>
                <div class="grade-score" id="gradeScore">-</div>
            </div>
        </div>

        <div class="content">
            <div class="student-info">
                <h2>Student Information</h2>
                <div class="info-grid">
                    <div class="info-field">
                        <label for="studentName">Student's Name:</label>
                        <input type="text" id="studentName" placeholder="Enter your name">
                    </div>
                    <div class="info-field">
                        <label for="studentClass">Class:</label>
                        <input type="text" id="studentClass" placeholder="Enter your class">
                    </div>
                    <div class="info-field">
                        <label for="studentNumber">Student's Number:</label>
                        <input type="text" id="studentNumber" placeholder="Enter your number">
                    </div>
                    <div class="info-field">
                        <label for="studentDate">Date:</label>
                        <input type="date" id="studentDate">
                    </div>

                </div>
                <button class="save-btn" id="saveBtn" onclick="saveStudentInfo()">Save Information</button>
            </div>

            <svg class="place-image" viewBox="0 0 800 300" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <linearGradient id="skyGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:#87CEEB;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#E0F6FF;stop-opacity:1" />
                    </linearGradient>
                    <linearGradient id="mountainGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:#8B7355;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#A0522D;stop-opacity:1" />
                    </linearGradient>
                </defs>
                
                <!-- Sky -->
                <rect width="800" height="200" fill="url(#skyGradient)"/>
                
                <!-- Mountains -->
                <polygon points="0,150 200,80 400,120 600,60 800,100 800,200 0,200" fill="url(#mountainGradient)"/>
                
                <!-- Lake -->
                <ellipse cx="400" cy="220" rx="350" ry="40" fill="#4682B4"/>
                
                <!-- Trees -->
                <circle cx="150" cy="180" r="25" fill="#228B22"/>
                <rect x="145" y="180" width="10" height="30" fill="#8B4513"/>
                
                <circle cx="650" cy="170" r="30" fill="#228B22"/>
                <rect x="645" y="170" width="10" height="35" fill="#8B4513"/>
                
                <!-- Clouds -->
                <circle cx="200" cy="50" r="20" fill="white" opacity="0.8"/>
                <circle cx="220" cy="45" r="25" fill="white" opacity="0.8"/>
                <circle cx="240" cy="50" r="20" fill="white" opacity="0.8"/>
                
                <circle cx="600" cy="40" r="18" fill="white" opacity="0.8"/>
                <circle cx="615" cy="35" r="22" fill="white" opacity="0.8"/>
                <circle cx="630" cy="40" r="18" fill="white" opacity="0.8"/>
                
                <!-- Sun -->
                <circle cx="700" cy="60" r="25" fill="#FFD700"/>
            </svg>

            <div id="exercisesContainer"></div>

            <button class="check-btn" id="checkBtn" onclick="checkAnswers()">Check Answers</button>
        </div>

        <div class="footer">
            <button class="footer-btn print" onclick="printWorksheet()">üñ®Ô∏è Print</button>
            <button class="footer-btn copy" onclick="copyContent()">üìã Copy</button>
            <button class="footer-btn pdf" onclick="downloadPDF()">üìÑ Download PDF</button>
            <button class="footer-btn docx" onclick="downloadDocx()">üìù Download DOCX</button>
            <button class="footer-btn screenshot" onclick="takeScreenshot()">üì∏ Screenshot</button>
        </div>
    </div>

    <script>
        // Exercise data
        const exercises = {
            fillInBlanks: [
                {
                    text: "The mountain peak is beautiful, _____ it's very difficult to climb.",
                    answer: "but",
                    options: ["but", "and", "so", "because"]
                },
                {
                    text: "We visited the beach _____ the weather was perfect.",
                    answer: "because",
                    options: ["because", "although", "while", "however"]
                },
                {
                    text: "The forest is peaceful _____ quiet, making it perfect for meditation.",
                    answer: "and",
                    options: ["and", "but", "or", "so"]
                },
                {
                    text: "_____ the rain stopped, we continued our hike through the valley.",
                    answer: "after",
                    options: ["after", "before", "during", "since"]
                },
                {
                    text: "The city is crowded, _____ the countryside is peaceful and serene.",
                    answer: "whereas",
                    options: ["whereas", "therefore", "moreover", "furthermore"]
                },
                {
                    text: "The hotel was expensive, _____ we decided to stay there anyway.",
                    answer: "yet",
                    options: ["yet", "so", "because", "since"]
                },
                {
                    text: "_____ we arrived at the museum, it was already closed for the day.",
                    answer: "when",
                    options: ["when", "while", "since", "until"]
                },
                {
                    text: "The park is beautiful in spring _____ in autumn when the leaves change color.",
                    answer: "as well as",
                    options: ["as well as", "instead of", "rather than", "except for"]
                },
                {
                    text: "_____ the traffic was heavy, we managed to reach the airport on time.",
                    answer: "despite",
                    options: ["despite", "because of", "due to", "owing to"]
                },
                {
                    text: "The restaurant serves local food; _____, it offers international cuisine.",
                    answer: "furthermore",
                    options: ["furthermore", "however", "nevertheless", "otherwise"]
                },
                {
                    text: "We can visit the castle _____ explore the nearby gardens.",
                    answer: "or",
                    options: ["or", "and", "but", "so"]
                },
                {
                    text: "_____ it was raining heavily, the outdoor concert was cancelled.",
                    answer: "since",
                    options: ["since", "unless", "provided that", "in case"]
                }
            ],
            matching: {
                conjunctions: [
                    { id: 1, text: "because", matchId: 1 },
                    { id: 2, text: "although", matchId: 2 },
                    { id: 3, text: "when", matchId: 3 },
                    { id: 4, text: "therefore", matchId: 4 },
                    { id: 5, text: "while", matchId: 5 },
                    { id: 6, text: "however", matchId: 6 },
                    { id: 7, text: "since", matchId: 7 },
                    { id: 8, text: "unless", matchId: 8 },
                    { id: 9, text: "moreover", matchId: 9 },
                    { id: 10, text: "nevertheless", matchId: 10 }
                ],
                meanings: [
                    { id: 1, text: "karena / sebab", matchId: 1 },
                    { id: 2, text: "meskipun / walaupun", matchId: 2 },
                    { id: 3, text: "ketika / saat", matchId: 3 },
                    { id: 4, text: "oleh karena itu / maka", matchId: 4 },
                    { id: 5, text: "sementara / selagi", matchId: 5 },
                    { id: 6, text: "namun / akan tetapi", matchId: 6 },
                    { id: 7, text: "sejak / karena (waktu lampau)", matchId: 7 },
                    { id: 8, text: "kecuali jika / jika tidak", matchId: 8 },
                    { id: 9, text: "selain itu / terlebih lagi", matchId: 9 },
                    { id: 10, text: "meskipun demikian / walau begitu", matchId: 10 },
                    { id: 11, text: "dengan demikian / akibatnya", matchId: null },
                    { id: 12, text: "sebaliknya / di sisi lain", matchId: null }
                ]
            },
            sentenceCreation: [
                {
                    prompt: "Write a sentence expressing an opinion using 'although' to show contrast:",
                    conjunction: "although",
                    example: "Although social media can be entertaining, it often wastes too much time."
                },
                {
                    prompt: "Create an argument sentence using 'because' to give a reason:",
                    conjunction: "because",
                    example: "Students should have longer lunch breaks because they need time to relax and socialize."
                },
                {
                    prompt: "Write an opinion using 'while' to compare two viewpoints:",
                    conjunction: "while",
                    example: "While some people prefer online shopping, others enjoy the experience of visiting stores."
                },
                {
                    prompt: "Create an argument using 'unless' to state a condition:",
                    conjunction: "unless",
                    example: "Schools cannot improve student performance unless they provide better resources and support."
                },
                {
                    prompt: "Write an opinion using 'moreover' to strengthen your argument:",
                    conjunction: "moreover",
                    example: "Homework helps students practice skills; moreover, it teaches them responsibility and time management."
                },
                {
                    prompt: "Create an argument using 'consequently' to show a result:",
                    conjunction: "consequently",
                    example: "Many teenagers spend too much time on phones; consequently, their sleep quality has decreased significantly."
                }
            ]
        };

        let shuffledExercises = {};
        let isChecked = false;
        let selectedMatches = {};
        let teacherMode = false;
        let matchingPairs = {};



        function showAnswers() {
            if (!teacherMode) return;
            
            // Show fill-in-the-blank answers
            shuffledExercises.fillInBlanks.forEach((exercise, index) => {
                const input = document.getElementById(`blank${index}`);
                if (input) {
                    input.value = exercise.answer;
                    input.style.backgroundColor = '#e8f5e8';
                    input.style.fontWeight = 'bold';
                }
            });

            // Show matching answers - highlight correct pairs
            shuffledExercises.matching.conjunctions.forEach(conjItem => {
                const correctMeaning = shuffledExercises.matching.meanings.find(m => m.matchId === conjItem.matchId);
                if (correctMeaning) {
                    const conjElement = document.querySelector(`.matching-item[data-type="conjunction"][data-id="${conjItem.id}"]`);
                    const meaningElement = document.querySelector(`.matching-item[data-type="meaning"][data-id="${correctMeaning.id}"]`);
                    
                    if (conjElement && meaningElement) {
                        conjElement.style.backgroundColor = '#e8f5e8';
                        conjElement.style.fontWeight = 'bold';
                        conjElement.style.border = '2px solid #28a745';
                        
                        meaningElement.style.backgroundColor = '#e8f5e8';
                        meaningElement.style.fontWeight = 'bold';
                        meaningElement.style.border = '2px solid #28a745';
                        
                        // Store the correct match for teacher mode
                        matchingPairs[conjItem.id] = correctMeaning.id;
                    }
                }
            });

            // Show sentence examples
            shuffledExercises.sentenceCreation.forEach((exercise, index) => {
                const textarea = document.getElementById(`sentence${index}`);
                if (textarea) {
                    textarea.value = exercise.example;
                    textarea.style.backgroundColor = '#e8f5e8';
                    textarea.style.fontWeight = 'bold';
                }
            });
        }

        function initializeWorksheet() {
            // Set today's date
            document.getElementById('studentDate').value = new Date().toISOString().split('T')[0];
            
            // Shuffle exercises
            shuffledExercises.fillInBlanks = [...exercises.fillInBlanks].sort(() => Math.random() - 0.5);
            shuffledExercises.matching = {
                conjunctions: [...exercises.matching.conjunctions].sort(() => Math.random() - 0.5),
                meanings: [...exercises.matching.meanings].sort(() => Math.random() - 0.5)
            };
            shuffledExercises.sentenceCreation = [...exercises.sentenceCreation].sort(() => Math.random() - 0.5);

            renderExercises();
        }

        function renderExercises() {
            const container = document.getElementById('exercisesContainer');
            let html = '';

            // Fill in the Blanks Section
            html += `
                <div class="section">
                    <h3>Part 1: Fill in the Blanks</h3>
                    <div class="instruction">
                        Choose the correct conjunction to complete each sentence about places. Use the word bank below to help you.
                    </div>
                    <div class="word-bank">
                        <h4>Word Bank:</h4>
                        <div class="word-bank-items">
                            <span class="word-bank-item">because</span>
                            <span class="word-bank-item">although</span>
                            <span class="word-bank-item">while</span>
                            <span class="word-bank-item">however</span>
                            <span class="word-bank-item">therefore</span>
                            <span class="word-bank-item">whereas</span>
                            <span class="word-bank-item">but</span>
                            <span class="word-bank-item">and</span>
                            <span class="word-bank-item">after</span>
                            <span class="word-bank-item">yet</span>
                            <span class="word-bank-item">when</span>
                            <span class="word-bank-item">as well as</span>
                            <span class="word-bank-item">despite</span>
                            <span class="word-bank-item">furthermore</span>
                            <span class="word-bank-item">or</span>
                            <span class="word-bank-item">since</span>
                            <span class="word-bank-item">unless</span>
                            <span class="word-bank-item">moreover</span>
                            <span class="word-bank-item">nevertheless</span>
                            <span class="word-bank-item">meanwhile</span>
                            <span class="word-bank-item">consequently</span>
                        </div>
                    </div>
            `;

            shuffledExercises.fillInBlanks.forEach((exercise, index) => {
                const parts = exercise.text.split('_____');
                html += `
                    <div class="question">
                        <div class="question-text">${index + 1}. ${parts[0]}<input type="text" class="fill-blank" id="blank${index}" data-answer="${exercise.answer}">${parts[1]}</div>
                    </div>
                `;
            });

            html += `</div>`;

            // Matching Section
            html += `
                <div class="section">
                    <h3>Part 2: Matching Exercise</h3>
                    <div class="instruction">
                        Match each conjunction with its Indonesian meaning. Click on a conjunction, then click on its matching Indonesian meaning.
                    </div>
                    <div class="matching-container">
                        <div class="matching-column">
                            <h4>Conjunctions</h4>
            `;

            shuffledExercises.matching.conjunctions.forEach((item, index) => {
                html += `
                    <div class="matching-item" data-type="conjunction" data-id="${item.id}" data-match-id="${item.matchId}" onclick="selectMatch('conjunction', ${item.id}, ${item.matchId})">
                        ${String.fromCharCode(65 + index)}. ${item.text}
                    </div>
                `;
            });

            html += `
                        </div>
                        <div class="matching-column">
                            <h4>Indonesian Meanings</h4>
            `;

            shuffledExercises.matching.meanings.forEach((item, index) => {
                html += `
                    <div class="matching-item" data-type="meaning" data-id="${item.id}" data-match-id="${item.matchId}" onclick="selectMatch('meaning', ${item.id}, ${item.matchId})">
                        ${index + 1}. ${item.text}
                    </div>
                `;
            });

            html += `
                        </div>
                    </div>
                </div>
            `;

            // Sentence Creation Section
            html += `
                <div class="section">
                    <h3>Part 3: Express Opinions and Arguments</h3>
                    <div class="instruction">
                        Write original sentences expressing opinions or making arguments using the given conjunctions. Focus on topics like school, technology, social issues, or personal beliefs. Make sure your sentences are complete and persuasive.
                    </div>
            `;

            shuffledExercises.sentenceCreation.forEach((exercise, index) => {
                html += `
                    <div class="question">
                        <div class="question-text">${index + 1}. ${exercise.prompt}</div>
                        <textarea class="sentence-area" id="sentence${index}" placeholder="Write your sentence here..." data-conjunction="${exercise.conjunction}"></textarea>
                    </div>
                `;
            });

            html += `</div>`;

            container.innerHTML = html;
            
            // If teacher mode is active, show answers
            if (teacherMode) {
                setTimeout(showAnswers, 100);
            }
        }

        function selectMatch(type, id, matchId) {
            if (isChecked) return;

            // Clear previous selections of the same type
            document.querySelectorAll(`.matching-item[data-type="${type}"]`).forEach(item => {
                item.classList.remove('selected');
            });

            // Select current item
            const selectedItem = document.querySelector(`.matching-item[data-type="${type}"][data-id="${id}"]`);
            selectedItem.classList.add('selected');

            // Store selection
            selectedMatches[type] = { id, matchId };

            // Check if we have both selections
            if (selectedMatches.conjunction && selectedMatches.meaning) {
                const conjId = selectedMatches.conjunction.id;
                const meaningId = selectedMatches.meaning.id;
                const conjMatchId = selectedMatches.conjunction.matchId;
                const meaningMatchId = selectedMatches.meaning.matchId;

                // Store the match
                matchingPairs[conjId] = meaningId;

                // Check if it's correct (both should have the same matchId and not null)
                if (conjMatchId === meaningMatchId && conjMatchId !== null) {
                    // Correct match - mark both items as correct
                    document.querySelector(`.matching-item[data-type="conjunction"][data-id="${conjId}"]`).classList.add('correct');
                    document.querySelector(`.matching-item[data-type="meaning"][data-id="${meaningId}"]`).classList.add('correct');
                } else {
                    // Incorrect match - mark both items as incorrect temporarily
                    document.querySelector(`.matching-item[data-type="conjunction"][data-id="${conjId}"]`).classList.add('incorrect');
                    document.querySelector(`.matching-item[data-type="meaning"][data-id="${meaningId}"]`).classList.add('incorrect');
                    
                    // Remove incorrect marking after 2 seconds
                    setTimeout(() => {
                        document.querySelector(`.matching-item[data-type="conjunction"][data-id="${conjId}"]`).classList.remove('incorrect');
                        document.querySelector(`.matching-item[data-type="meaning"][data-id="${meaningId}"]`).classList.remove('incorrect');
                    }, 2000);
                }

                // Clear selections after a brief moment
                setTimeout(() => {
                    document.querySelectorAll('.matching-item.selected').forEach(item => {
                        item.classList.remove('selected');
                    });
                    selectedMatches = {};
                }, 500);
            }
        }

        function saveStudentInfo() {
            const inputs = ['studentName', 'studentClass', 'studentNumber', 'studentDate'];
            inputs.forEach(id => {
                document.getElementById(id).disabled = true;
            });
            document.getElementById('saveBtn').disabled = true;
            document.getElementById('saveBtn').textContent = 'Information Saved';
        }

        function checkAnswers() {
            if (isChecked) return;

            let totalQuestions = 0;
            let correctAnswers = 0;

            // Check fill-in-the-blanks
            shuffledExercises.fillInBlanks.forEach((exercise, index) => {
                const input = document.getElementById(`blank${index}`);
                const userAnswer = input.value.trim().toLowerCase();
                const correctAnswer = exercise.answer.toLowerCase();
                
                totalQuestions++;
                if (userAnswer === correctAnswer) {
                    input.classList.add('correct');
                    correctAnswers++;
                } else {
                    input.classList.add('incorrect');
                }
            });

            // Check matching exercise
            shuffledExercises.matching.conjunctions.forEach(conjItem => {
                totalQuestions++;
                const matchedMeaningId = matchingPairs[conjItem.id];
                if (matchedMeaningId) {
                    const meaningItem = shuffledExercises.matching.meanings.find(m => m.id === matchedMeaningId);
                    if (meaningItem && conjItem.matchId === meaningItem.matchId && conjItem.matchId !== null) {
                        correctAnswers++;
                    }
                }
            });

            // Show correct answers for unmatched items
            shuffledExercises.matching.conjunctions.forEach(conjItem => {
                const conjElement = document.querySelector(`.matching-item[data-type="conjunction"][data-id="${conjItem.id}"]`);
                if (!conjElement.classList.contains('correct')) {
                    const correctMeaning = shuffledExercises.matching.meanings.find(m => m.matchId === conjItem.matchId);
                    if (correctMeaning) {
                        const meaningElement = document.querySelector(`.matching-item[data-type="meaning"][data-id="${correctMeaning.id}"]`);
                        conjElement.style.border = '2px solid #ffc107';
                        meaningElement.style.border = '2px solid #ffc107';
                    }
                }
            });

            // Check sentence creation (simplified - check if conjunction is used)
            shuffledExercises.sentenceCreation.forEach((exercise, index) => {
                const textarea = document.getElementById(`sentence${index}`);
                const userSentence = textarea.value.trim().toLowerCase();
                const requiredConjunction = exercise.conjunction.toLowerCase();
                
                totalQuestions++;
                textarea.classList.add('checked');
                
                if (userSentence.includes(requiredConjunction) && userSentence.length > 20) {
                    correctAnswers++;
                    textarea.style.borderColor = '#28a745';
                } else {
                    textarea.style.borderColor = '#dc3545';
                }
            });

            // Calculate and display grade
            const percentage = Math.round((correctAnswers / totalQuestions) * 100);
            document.getElementById('gradeScore').textContent = `${percentage}%`;
            document.getElementById('checkBtn').disabled = true;
            document.getElementById('checkBtn').textContent = 'Answers Checked';
            isChecked = true;
        }

        function printWorksheet() {
            window.print();
        }

        function copyContent() {
            const worksheet = document.getElementById('worksheet');
            const range = document.createRange();
            range.selectNode(worksheet);
            window.getSelection().removeAllRanges();
            window.getSelection().addRange(range);
            document.execCommand('copy');
            window.getSelection().removeAllRanges();
            alert('Worksheet content copied to clipboard!');
        }

        function downloadPDF() {
            const { jsPDF } = window.jspdf;
            
            // Create PDF with optimized settings for smaller file size
            html2canvas(document.getElementById('worksheet'), {
                scale: 1.5, // Reduced scale for smaller file size
                useCORS: true,
                allowTaint: true,
                backgroundColor: '#ffffff',
                removeContainer: true,
                imageTimeout: 0,
                logging: false
            }).then(canvas => {
                // Compress image to JPEG with quality setting for smaller size
                const imgData = canvas.toDataURL('image/jpeg', 0.8); // 80% quality
                const pdf = new jsPDF('p', 'mm', 'a4');
                const imgWidth = 210;
                const pageHeight = 295;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;

                // Add first page
                pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight, undefined, 'FAST');
                heightLeft -= pageHeight;

                // Add additional pages if needed
                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight, undefined, 'FAST');
                    heightLeft -= pageHeight;
                }

                pdf.save('conjunction-practice-worksheet.pdf');
            }).catch(error => {
                console.error('PDF generation failed:', error);
                alert('PDF generation failed. Please try again.');
            });
        }

        function downloadDocx() {
            try {
                // Get student information
                const studentName = document.getElementById('studentName').value || 'Not provided';
                const studentClass = document.getElementById('studentClass').value || 'Not provided';
                const studentNumber = document.getElementById('studentNumber').value || 'Not provided';
                const studentDate = document.getElementById('studentDate').value || 'Not provided';
                const grade = document.getElementById('gradeScore').textContent;

                // Create RTF content (Rich Text Format - opens in Word)
                let rtfContent = `{\\rtf1\\ansi\\deff0 {\\fonttbl {\\f0 Times New Roman;}}
\\f0\\fs24 
{\\qc\\b\\fs32 Conjunction Practice Worksheet\\par}
\\par
{\\qr\\b Grade: ${grade}\\par}
\\par\\par
{\\b Student Information\\par}
\\par
Name: ${studentName}\\par
Class: ${studentClass}\\par
Student Number: ${studentNumber}\\par
Date: ${studentDate}\\par
\\par\\par
{\\b Part 1: Fill in the Blanks\\par}
\\par`;

                // Add fill-in-the-blank questions
                shuffledExercises.fillInBlanks.forEach((exercise, index) => {
                    const input = document.getElementById(`blank${index}`);
                    const userAnswer = input ? input.value : '____';
                    const questionText = exercise.text.replace('_____', `[${userAnswer}]`);
                    rtfContent += `${index + 1}. ${questionText}\\par\\par`;
                });

                rtfContent += `\\par{\\b Part 2: Matching Exercise\\par}\\par`;
                
                // Add matching results
                let matchingResults = '';
                shuffledExercises.matching.conjunctions.forEach((conjItem, index) => {
                    const matchedMeaningId = matchingPairs[conjItem.id];
                    let matchedText = 'Not matched';
                    if (matchedMeaningId) {
                        const meaningItem = shuffledExercises.matching.meanings.find(m => m.id === matchedMeaningId);
                        if (meaningItem) {
                            matchedText = meaningItem.text;
                        }
                    }
                    matchingResults += `${String.fromCharCode(65 + index)}. ${conjItem.text} ‚Üí ${matchedText}\\par`;
                });
                rtfContent += matchingResults + '\\par\\par';

                rtfContent += `{\\b Part 3: Sentence Creation\\par}\\par`;

                // Add sentence creation
                shuffledExercises.sentenceCreation.forEach((exercise, index) => {
                    const textarea = document.getElementById(`sentence${index}`);
                    const userSentence = textarea ? textarea.value : '[No answer provided]';
                    rtfContent += `${index + 1}. ${exercise.prompt}\\par`;
                    rtfContent += `Answer: ${userSentence}\\par\\par`;
                });

                rtfContent += '}';

                // Create and download the file
                const blob = new Blob([rtfContent], { type: 'application/rtf' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'conjunction-practice-worksheet.rtf';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href);

            } catch (error) {
                console.error('Document export error:', error);
                // Fallback to plain text if RTF fails
                try {
                    const studentName = document.getElementById('studentName').value || 'Not provided';
                    const studentClass = document.getElementById('studentClass').value || 'Not provided';
                    const studentNumber = document.getElementById('studentNumber').value || 'Not provided';
                    const studentDate = document.getElementById('studentDate').value || 'Not provided';
                    const grade = document.getElementById('gradeScore').textContent;

                    let textContent = `CONJUNCTION PRACTICE WORKSHEET\n\n`;
                    textContent += `Grade: ${grade}\n\n`;
                    textContent += `STUDENT INFORMATION\n`;
                    textContent += `Name: ${studentName}\n`;
                    textContent += `Class: ${studentClass}\n`;
                    textContent += `Student Number: ${studentNumber}\n`;
                    textContent += `Date: ${studentDate}\n\n`;
                    
                    textContent += `PART 1: FILL IN THE BLANKS\n\n`;
                    shuffledExercises.fillInBlanks.forEach((exercise, index) => {
                        const input = document.getElementById(`blank${index}`);
                        const userAnswer = input ? input.value : '____';
                        const questionText = exercise.text.replace('_____', `[${userAnswer}]`);
                        textContent += `${index + 1}. ${questionText}\n\n`;
                    });

                    textContent += `PART 3: SENTENCE CREATION\n\n`;
                    shuffledExercises.sentenceCreation.forEach((exercise, index) => {
                        const textarea = document.getElementById(`sentence${index}`);
                        const userSentence = textarea ? textarea.value : '[No answer provided]';
                        textContent += `${index + 1}. ${exercise.prompt}\n`;
                        textContent += `Answer: ${userSentence}\n\n`;
                    });

                    const blob = new Blob([textContent], { type: 'text/plain' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = 'conjunction-practice-worksheet.txt';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(link.href);
                } catch (fallbackError) {
                    alert('Document export failed. Please try the PDF option instead.');
                }
            }
        }

        function takeScreenshot() {
            html2canvas(document.getElementById('worksheet'), {
                scale: 2,
                useCORS: true,
                allowTaint: true
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'conjunction-practice-worksheet.png';
                link.href = canvas.toDataURL();
                link.click();
            });
        }

        // Secret teacher mode activation
        let secretSequence = [];
        let tapSequence = [];
        const targetSequence = ['1', '3', '3', '2', '4', '1', '2', '4'];
        let lastTapTime = 0;
        
        // Keyboard activation (desktop)
        document.addEventListener('keydown', function(event) {
            secretSequence.push(event.key.toLowerCase());
            
            // Keep only the last 8 keys
            if (secretSequence.length > targetSequence.length) {
                secretSequence.shift();
            }
            
            // Check if sequence matches
            if (secretSequence.length === targetSequence.length && 
                secretSequence.every((key, index) => key === targetSequence[index])) {
                if (!teacherMode) {
                    teacherMode = true;
                    showAnswers();
                    alert('üéì Teacher mode activated! All answers are now visible.');
                }
                secretSequence = []; // Reset sequence
            }
        });

        // Touch activation (mobile) - tap the grade box in sequence
        document.getElementById('gradeScore').addEventListener('click', function() {
            const currentTime = Date.now();
            
            // Reset if more than 3 seconds between taps
            if (currentTime - lastTapTime > 3000) {
                tapSequence = [];
            }
            
            lastTapTime = currentTime;
            tapSequence.push('tap');
            
            // Need 8 taps for the code 13324124
            if (tapSequence.length === 8) {
                if (!teacherMode) {
                    teacherMode = true;
                    showAnswers();
                    alert('üéì Teacher mode activated! All answers are now visible.');
                }
                tapSequence = [];
            }
            
            // Keep only last 8 taps
            if (tapSequence.length > 8) {
                tapSequence.shift();
            }
        });

        // Alternative: Long press on header for mobile
        let longPressTimer;
        const header = document.querySelector('.header h1');
        
        header.addEventListener('touchstart', function(e) {
            longPressTimer = setTimeout(function() {
                if (!teacherMode) {
                    teacherMode = true;
                    showAnswers();
                    alert('üéì Teacher mode activated! All answers are now visible.');
                }
            }, 3000); // 3 second long press
        });
        
        header.addEventListener('touchend', function(e) {
            clearTimeout(longPressTimer);
        });
        
        header.addEventListener('touchmove', function(e) {
            clearTimeout(longPressTimer);
        });

        // Initialize the worksheet when page loads
        window.onload = initializeWorksheet;
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9804e42704a44717',t:'MTc1ODA3MzE4MS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
